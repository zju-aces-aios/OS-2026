# 操作系统实验一报告

**姓名：王伟桥**  
**学号：22551312**  
**实验名称：Lab1 内存分配机制分析**

---

## 一、实验目的

通过分析和调试 OS-2026 实验代码，理解操作系统中内存分配的基本原理，包括：
- 内存页分配（palloc）与小块分配（salloc）的区别；
- `uk_malloc()` 的分配策略；
- 常见的分配错误与调试修复方法。

---

## 二、实验环境

- **系统环境**：Ubuntu 22.04  
- **QEMU**：用于模拟 ARM64 平台  
- **GDB-Multiarch**：用于远程调试  
- **项目仓库**：[https://github.com/zju-aces-aios/OS-2026](https://github.com/zju-aces-aios/OS-2026)

---

## 三、实验步骤

1. **克隆并进入项目**

   ```bash
   git clone https://github.com/zju-aces-aios/OS-2026.git
   cd OS-2026/app-helloworld
   ```

2. **配置与编译**

   ```bash
   UK_DEFCONFIG=$(pwd)/defconfigs/qemu-arm64 make defconfig
   make -j8
   ```

3. **启动 QEMU 并开启 GDB 调试端口**

   ```bash
   qemu-system-aarch64        -kernel workdir/build/helloworld_qemu-arm64        -nographic -machine virt -cpu cortex-a57 -s -S
   ```

4. **在另一个终端使用 GDB 连接**

   ```bash
   gdb-multiarch workdir/build/helloworld_qemu-arm64.dbg        --eval-command="target remote :1234"
   ```

5. **设置断点进行调试**

   ```gdb
   (gdb) b main
   (gdb) b uk_free_ifpages
   ```

---

## 四、任务一：内存分配大小分析

| 请求分配大小 | 判定依据 | 分配路径 | 实际分配大小 | 分析说明 |
|---------------|-----------|-----------|---------------|------------|
| 96 B  | 96 + 32 = 128 ≤ 819 | salloc | 128 | 1×128B 小块 |
| 128 B | 128 + 32 = 160 ≤ 819 | salloc | 256 | 2×128B 小块 |
| 256 B | 256 + 32 = 288 ≤ 819 | salloc | 384 | 3×128B 小块 |
| 4064 B | 4064 + 32 = 4096 > 819 | palloc | 4096 | 1×4 KB 页 |
| 4096 B | 4096 + 32 = 4128 > 819 | palloc | 8192 | 2×4 KB 页 |

**结论**：  
当分配请求（含元数据）小于 819B 时使用 **salloc**（小块分配），  
大于等于 819B 时使用 **palloc**（页分配）。

---

## 五、任务二：核心问题解析

### Q1. 最小分配单元是什么？如何定义？

- **页分配（palloc）**：以 4KB 为最小页单位。  
- **小块分配（salloc）**：以 128B 为最小小块单位。  
  小块由从 buddy 系统借出的 1 页分成 32 份。

---

### Q2. `uk_malloc()` 何时选择 palloc，何时选择 salloc？

- 程序先计算：申请字节数 + 32B 元数据。
- 若结果 **≤ 819B** → 走 **salloc** 分配；
- 若结果 **> 819B** → 走 **palloc** 分配。
- 该判断逻辑由 `IS_SMALL` 宏和 `alloc.c` 中的分流代码实现。

---

### Q3. 大内存分配的设计问题与修复

**问题现象：**  
`free` 操作时参数 `small` 未正确传递，导致 `uk_get_metadata()` 进入错误分支，并将错误的 `num_pages` 传递给 `bbuddy_pfree`，引发异常。

**验证方法：**
在 GDB 调试时修改变量：
```gdb
b uk_free_ifpages
p small
set var small = 0
```
**结果：**  
修改后程序运行正常，释放逻辑正确。

---

## 六、实验总结

通过本次实验，我理解了操作系统中两种典型的内存分配方式：
- **salloc** 适用于小内存，分配效率高；
- **palloc** 适用于大内存，按页分配更灵活；
- 调试过程揭示了元数据与标志变量的重要性。

此外，通过 GDB 的调试实践，掌握了远程调试 QEMU 虚拟机的方法，对操作系统底层内存管理有了更直观的认识。

---

**实验完成日期：2025 年 11 月 3 日**
