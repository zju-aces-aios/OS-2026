# 实验一：Unikraft内存分配策略分析

### 1. **内存分配大小分析**

| 请求分配大小 | 实际分配大小 | 分析与说明 |
| :----------: | :----------: | :--------: |
|   96 字节    |     128B     |   salloc   |
|   128 字节   |     256B     |   salloc   |
|   256 字节   |     384B     |   salloc   |
|  4064 字节   |    4096B     |   palloc   |
|  4096 字节   |    8192B     |   palloc   |

METADATA_IFPAGES_SIZE_POW2是一个用以分配和对齐小页metadata的宏，这里留作32字节。

![图片1](.\图片1.png) 

传入的需分配空间参数size会加上这个宏的大小也就是32字节，换言之分配空间时需要多分配32字节用以进行对齐。

![图片2](.\图片2.png) 

小内存使用Slub分配器进行分配，最小内存块为128B。

分配96B时，加上32B为128B，Slub分配器分出1块内存块，共128B。

![图片3](.\图片3.png)

分配128B时，加上32B为160B，Slub分配器分出2块内存块，共256B。

![图片4](.\图片4.png) 

分配256B时，加上32B为288B，Slub分配器分出3块内存块，共384B。

![图片5](.\图片5.png) 

大内存使用Buddy分配器进行分配，最小内存块为4KB。

分配4064B时，加上32B为4KB，Buddy分配器分出1个0阶内存块，共4KB。

![图片6](.\图片6.png) 

![图片7](.\图片7.png) 

分配4096B时，加上32B为4128B，Buddy分配器分出1个1阶内存块，共8KB。

![图片8](.\图片8.png) 

![图片9](.\图片9.png) 



### 2. **最小分配单元：Unikraft两种内存分配策略的最小单元是多少？它是如何定义的？**

Buddy分配器的最小单元为4KB，通过无符号整型1左移12位设置。

![图片](.\图片10.png) 

Slab分配器的最小单元为128B，通过无符号整型1左移7位设置。

![图片](.\图片11.png) 

 

### 3. **分配器选择: uk_malloc()函数在何种条件下会选择palloc，又在何种条件下会选择salloc？**

![图片](.\图片12.png) 

函数判断传入的size大小与五分之一的页面大小之间的关系，如果size大于等于819B就使用palloc进行分配，否则使用salloc。

![图片](.\图片13.png) 

 

### 4. **大内存分配问题: 当前palloc在处理大内存（例如，一次性分配多个页面）的分配与回收时，存在一个已知的设计问题。请定位该问题，并尝试在GDB中通过set命令修改相关变量，模拟正确的free过程，并截图记录结果。**

![图片](.\图片14.png) 

 

问题：pfree无法正确启动，palloc之后会进行sfree

解决：在函数入口uk_realloc_ifpages处打断点，需要进行pfree时通过gdb将判断用变量small修改为0进行下一步，可以手动实现pfree的启动。

![图片](.\图片15.png) 

![图片](.\图片16.png) 

![图片](.\图片17.png) 

 

 

 

 

 